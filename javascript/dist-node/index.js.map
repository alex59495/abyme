{"version":3,"file":"index.js","sources":["../dist-src/abyme_controller.js"],"sourcesContent":["function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { Controller } from 'stimulus';\nexport default class _class extends Controller {\n  // static targets = ['template', 'associations', 'fields', 'newFields'];\n  // Some applications don't compile correctly with the usual static syntax. \n  // Thus implementing targets with standard getters below\n  connect() {\n    console.log(\"Abyme Connected\");\n\n    if (this.count) {\n      // If data-count is present,\n      // add n default fields on page load\n      this.add_default_associations();\n    }\n  } // return the value of the data-count attribute\n\n\n  get count() {\n    return this.element.dataset.minCount || 0;\n  } // return the value of the data-position attribute\n  // if there is no position specified set end as default\n\n\n  get position() {\n    return this.associationsTarget.dataset.abymePosition === 'end' ? 'beforeend' : 'afterbegin';\n  } // ADD_ASSOCIATION\n  // this function is call whenever a click occurs\n  // on the element with the click->abyme#add_association\n  // <button> element by default\n  // if a data-count is present the add_association\n  // will be call without an event so we have to check\n  // this case\n  // check for limit reached \n  // dispatch an event if the limit is reached\n  // - call the function build_html that take care\n  //   for building the correct html to be inserted in the DOM\n  // - dispatch an event before insert\n  // - insert html into the dom\n  // - dispatch an event after insert\n\n\n  add_association(event) {\n    if (event) {\n      event.preventDefault();\n    }\n\n    if (this.element.dataset.limit && this.limit_check()) {\n      this.create_event('limit-reached');\n      return false;\n    }\n\n    const html = this.build_html();\n    this.create_event('before-add');\n    this.associationsTarget.insertAdjacentHTML(this.position, html);\n    this.create_event('after-add');\n  } // REMOVE_ASSOCIATION\n  // this function is call whenever a click occurs\n  // on the element with the click->abyme#remove_association\n  // <button> element by default\n  // - call the function mark_for_destroy that takes care\n  //   of marking the element for destruction and hiding it\n  // - dispatch an event before mark & hide\n  // - mark for descrution + hide the element\n  // - dispatch an event after mark and hide\n\n\n  remove_association(event) {\n    event.preventDefault();\n    this.create_event('before-remove');\n    this.mark_for_destroy(event);\n    this.create_event('after-remove');\n  } // LIFECYCLE EVENTS RELATED\n  // CREATE_EVENT\n  // take a stage (String) => before-add, after-add...\n  // create a new custom event \n  // and dispatch at at the controller level\n\n\n  create_event(stage, html = null) {\n    const event = new CustomEvent(`abyme:${stage}`, {\n      detail: {\n        controller: this,\n        content: html\n      }\n    });\n    this.element.dispatchEvent(event); // WIP\n\n    this.dispatch(event, stage);\n  } // WIP : Trying to integrate event handling through controller inheritance\n\n\n  dispatch(event, stage) {\n    if (stage === 'before-add' && this.abymeBeforeAdd) this.abymeBeforeAdd(event);\n    if (stage === 'after-add' && this.abymeAfterAdd) this.abymeAfterAdd(event);\n    if (stage === 'before-remove' && this.abymeBeforeRemove) this.abymeBeforeAdd(event);\n    if (stage === 'after-remove' && this.abymeAfterRemove) this.abymeAfterRemove(event);\n  }\n\n  abymeBeforeAdd(event) {}\n\n  abymeAfterAdd(event) {}\n\n  abymeBeforeRemove(event) {}\n\n  abymeAfterRemove(event) {} // BUILD HTML\n  // takes the html template and substitutes the sub-string\n  // NEW_RECORD for a generated timestamp\n  // then if there is a sub template in the html (multiple nested level)\n  // set all the sub timestamps back as NEW_RECORD\n  // finally returns the html  \n\n\n  build_html() {\n    let html = this.templateTarget.innerHTML.replace(/NEW_RECORD/g, new Date().getTime());\n\n    if (html.match(/<template[\\s\\S]+<\\/template>/)) {\n      const template = html.match(/<template[\\s\\S]+<\\/template>/)[0].replace(/(\\[\\d{12,}\\])(\\[[^\\[\\]]+\\]\"){1}/g, `[NEW_RECORD]$2`);\n      html = html.replace(/<template[\\s\\S]+<\\/template>/g, template);\n    }\n\n    return html;\n  } // MARK_FOR_DESTROY\n  // mark association for destruction\n  // get the closest abyme--fields from the remove_association button\n  // set the _destroy input value as 1\n  // hide the element\n  // add the class of abyme--marked-for-destroy to the element\n\n\n  mark_for_destroy(event) {\n    let item = event.target.closest('.abyme--fields');\n    item.querySelector(\"input[name*='_destroy']\").value = 1;\n    item.style.display = 'none';\n    item.classList.add('abyme--marked-for-destroy');\n  } // LIMIT_CHECK\n  // Check if associations limit is reached\n  // based on newFieldsTargets only\n  // persisted fields are ignored\n\n\n  limit_check() {\n    return this.newFieldsTargets.filter(item => !item.classList.contains('abyme--marked-for-destroy')).length >= parseInt(this.element.dataset.limit);\n  } // ADD_DEFAULT_ASSOCIATION\n  // Add n default blank associations at page load\n  // call sleep function to ensure uniqueness of timestamp\n\n\n  async add_default_associations() {\n    let i = 0;\n\n    while (i < this.count) {\n      this.add_association();\n      i++;\n      await this.sleep(1);\n    }\n  }\n\n  sleep(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n}\n\n_defineProperty(_class, \"targets\", ['template', 'associations', 'fields', 'newFields']);"],"names":["_defineProperty","obj","key","value","Object","defineProperty","enumerable","configurable","writable","_class","Controller","connect","console","log","count","add_default_associations","element","dataset","minCount","position","associationsTarget","abymePosition","add_association","event","preventDefault","limit","limit_check","create_event","html","build_html","insertAdjacentHTML","remove_association","mark_for_destroy","stage","CustomEvent","detail","controller","content","dispatchEvent","dispatch","abymeBeforeAdd","abymeAfterAdd","abymeBeforeRemove","abymeAfterRemove","templateTarget","innerHTML","replace","Date","getTime","match","template","item","target","closest","querySelector","style","display","classList","add","newFieldsTargets","filter","contains","length","parseInt","i","sleep","ms","Promise","resolve","setTimeout"],"mappings":"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"}