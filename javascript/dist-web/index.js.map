{"version":3,"file":"index.js","sources":["../dist-src/abyme_controller.js"],"sourcesContent":["function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { Controller } from 'stimulus';\nexport default class _class extends Controller {\n  // static targets = ['template', 'associations', 'fields', 'newFields'];\n  // Some applications don't compile correctly with the usual static syntax. \n  // Thus implementing targets with standard getters below\n  connect() {\n    console.log(\"Abyme Connected\");\n\n    if (this.count) {\n      // If data-count is present,\n      // add n default fields on page load\n      this.add_default_associations();\n    }\n  } // return the value of the data-count attribute\n\n\n  get count() {\n    return this.element.dataset.minCount || 0;\n  } // return the value of the data-position attribute\n  // if there is no position specified set end as default\n\n\n  get position() {\n    return this.associationsTarget.dataset.abymePosition === 'end' ? 'beforeend' : 'afterbegin';\n  } // ADD_ASSOCIATION\n  // this function is call whenever a click occurs\n  // on the element with the click->abyme#add_association\n  // <button> element by default\n  // if a data-count is present the add_association\n  // will be call without an event so we have to check\n  // this case\n  // check for limit reached \n  // dispatch an event if the limit is reached\n  // - call the function build_html that take care\n  //   for building the correct html to be inserted in the DOM\n  // - dispatch an event before insert\n  // - insert html into the dom\n  // - dispatch an event after insert\n\n\n  add_association(event) {\n    if (event) {\n      event.preventDefault();\n    }\n\n    if (this.element.dataset.limit && this.limit_check()) {\n      this.create_event('limit-reached');\n      return false;\n    }\n\n    const html = this.build_html();\n    this.create_event('before-add');\n    this.associationsTarget.insertAdjacentHTML(this.position, html);\n    this.create_event('after-add');\n  } // REMOVE_ASSOCIATION\n  // this function is call whenever a click occurs\n  // on the element with the click->abyme#remove_association\n  // <button> element by default\n  // - call the function mark_for_destroy that takes care\n  //   of marking the element for destruction and hiding it\n  // - dispatch an event before mark & hide\n  // - mark for descrution + hide the element\n  // - dispatch an event after mark and hide\n\n\n  remove_association(event) {\n    event.preventDefault();\n    this.create_event('before-remove');\n    this.mark_for_destroy(event);\n    this.create_event('after-remove');\n  } // LIFECYCLE EVENTS RELATED\n  // CREATE_EVENT\n  // take a stage (String) => before-add, after-add...\n  // create a new custom event \n  // and dispatch at at the controller level\n\n\n  create_event(stage, html = null) {\n    const event = new CustomEvent(`abyme:${stage}`, {\n      detail: {\n        controller: this,\n        content: html\n      }\n    });\n    this.element.dispatchEvent(event); // WIP\n\n    this.dispatch(event, stage);\n  } // WIP : Trying to integrate event handling through controller inheritance\n\n\n  dispatch(event, stage) {\n    if (stage === 'before-add' && this.abymeBeforeAdd) this.abymeBeforeAdd(event);\n    if (stage === 'after-add' && this.abymeAfterAdd) this.abymeAfterAdd(event);\n    if (stage === 'before-remove' && this.abymeBeforeRemove) this.abymeBeforeAdd(event);\n    if (stage === 'after-remove' && this.abymeAfterRemove) this.abymeAfterRemove(event);\n  }\n\n  abymeBeforeAdd(event) {}\n\n  abymeAfterAdd(event) {}\n\n  abymeBeforeRemove(event) {}\n\n  abymeAfterRemove(event) {} // BUILD HTML\n  // takes the html template and substitutes the sub-string\n  // NEW_RECORD for a generated timestamp\n  // then if there is a sub template in the html (multiple nested level)\n  // set all the sub timestamps back as NEW_RECORD\n  // finally returns the html  \n\n\n  build_html() {\n    let html = this.templateTarget.innerHTML.replace(/NEW_RECORD/g, new Date().getTime());\n\n    if (html.match(/<template[\\s\\S]+<\\/template>/)) {\n      const template = html.match(/<template[\\s\\S]+<\\/template>/)[0].replace(/(\\[\\d{12,}\\])(\\[[^\\[\\]]+\\]\"){1}/g, `[NEW_RECORD]$2`);\n      html = html.replace(/<template[\\s\\S]+<\\/template>/g, template);\n    }\n\n    return html;\n  } // MARK_FOR_DESTROY\n  // mark association for destruction\n  // get the closest abyme--fields from the remove_association button\n  // set the _destroy input value as 1\n  // hide the element\n  // add the class of abyme--marked-for-destroy to the element\n\n\n  mark_for_destroy(event) {\n    let item = event.target.closest('.abyme--fields');\n    item.querySelector(\"input[name*='_destroy']\").value = 1;\n    item.style.display = 'none';\n    item.classList.add('abyme--marked-for-destroy');\n  } // LIMIT_CHECK\n  // Check if associations limit is reached\n  // based on newFieldsTargets only\n  // persisted fields are ignored\n\n\n  limit_check() {\n    return this.newFieldsTargets.filter(item => !item.classList.contains('abyme--marked-for-destroy')).length >= parseInt(this.element.dataset.limit);\n  } // ADD_DEFAULT_ASSOCIATION\n  // Add n default blank associations at page load\n  // call sleep function to ensure uniqueness of timestamp\n\n\n  async add_default_associations() {\n    let i = 0;\n\n    while (i < this.count) {\n      this.add_association();\n      i++;\n      await this.sleep(1);\n    }\n  }\n\n  sleep(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n}\n\n_defineProperty(_class, \"targets\", ['template', 'associations', 'fields', 'newFields']);"],"names":[],"mappings":"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"}